---
/**
 * PresentationTrigger - Botón para activar el Modo Presentación
 *
 * Este botón sutil permite a los profesores activar herramientas de anotación
 * (láser, lápiz, flechas) sobre cualquier lección.
 *
 * El JavaScript del modo presentación se carga dinámicamente solo cuando
 * el usuario hace clic, evitando impacto en la carga inicial de la página.
 */
---

<div id="presentation-trigger-wrapper">
  <button
    id="presentation-trigger"
    class="presentation-trigger"
    aria-label="Modo Clase"
    title="Activar Modo Presentación (Ctrl+Shift+P)"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
      <line x1="15" y1="5" x2="19" y2="9"></line>
    </svg>
  </button>
</div>

<script>
  import { PresentationController } from "../../scripts/presentation/PresentationController";

  let controller: PresentationController | null = null;

  const initPresentationMode = () => {
    if (!controller) {
      controller = new PresentationController(() => {
        controller = null;
        const b = document.getElementById("presentation-trigger");
        if (b) b.classList.remove("loading");
      });
    }
  };

  // Logic to make the trigger button sticky during zoom (Visual Viewport)
  // We apply the positioning/scaling to the WRAPPER, so the button
  // can maintain its own hover/pulse transforms without conflict.
  const wrapper = document.getElementById("presentation-trigger-wrapper");
  const btn = document.getElementById("presentation-trigger");

  const updateTriggerPosition = () => {
    if (!wrapper || !window.visualViewport) return;
    const vv = window.visualViewport;
    const scale = 1 / vv.scale;

    // Position: Bottom-Right corner (approx 20px from edges + button size)
    // We calculate absolute position relative to layout viewport
    const x = vv.offsetLeft + vv.width - 75 * scale;
    const y = vv.offsetTop + vv.height - 75 * scale;

    wrapper.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
  };

  if (window.visualViewport) {
    window.visualViewport.addEventListener("resize", updateTriggerPosition);
    window.visualViewport.addEventListener("scroll", updateTriggerPosition);
    // Initial call
    requestAnimationFrame(updateTriggerPosition);
  }

  // Click Handler
  btn?.addEventListener("click", async () => {
    btn.classList.add("loading");
    // Small delay to allow UI feedback
    setTimeout(() => {
      initPresentationMode();
    }, 50);
  });

  // Hotkey Handler
  document.addEventListener("keydown", async (e) => {
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === "p") {
      e.preventDefault();
      const b = document.getElementById("presentation-trigger");
      if (b) b.classList.add("loading");
      initPresentationMode();
    }
  });
</script>

<style>
  /* Wrapper handles the "Sticky" positioning via JS transform */
  #presentation-trigger-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    width: 0;
    height: 0;
    z-index: 50;
    transform-origin: 0 0;
    pointer-events: none; /* Let clicks pass through the wrapper */
    will-change: transform;
  }

  /* Button handles the visual style and interaction */
  .presentation-trigger {
    pointer-events: auto; /* Re-enable clicks */
    position: relative; /* Relative to the wrapper's translated position */
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: #2563eb;
    color: white;
    border: none;
    box-shadow: 0 4px 14px rgba(37, 99, 235, 0.4);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition:
      transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1),
      background-color 0.2s;
  }

  .presentation-trigger:hover {
    background: #1d4ed8;
    transform: scale(1.1);
  }

  .presentation-trigger.loading {
    animation: pulse 1.5s infinite;
    pointer-events: none;
    opacity: 0.9;
  }

  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7);
    }
    70% {
      box-shadow: 0 0 0 15px rgba(37, 99, 235, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
    }
  }

  /* Ocultar en móviles muy pequeños si es necesario, pero permitir en tablets */
  @media (max-width: 480px) {
    /* Podríamos ajustar el tamaño o posición, pero por ahora lo dejamos visible */
    /* o si se prefiere ocultar solo en móviles muy pequeños */
  }

  /* Ocultar al imprimir */
  @media print {
    #presentation-trigger-wrapper {
      display: none !important;
    }
  }
</style>
