---
interface Props {
    title: string;
}

const { title } = Astro.props;
---

<div class="concept-map-wrapper" data-title={title}>
    <div class="concept-map-container">
        <!-- Botón de Descarga (Oculto en impresión/captura) -->
        <button
            class="download-map-btn"
            title="Descargar como Imagen"
            aria-label="Descargar mapa conceptual"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                ></path><polyline points="7 10 12 15 17 10"></polyline><line
                    x1="12"
                    y1="15"
                    x2="12"
                    y2="3"></line></svg
            >
            <span>Descargar</span>
        </button>

        <div class="map-root">
            <div class="root-label">{title}</div>
            <div class="root-v-line">║</div>
        </div>
        <div class="map-branches">
            <slot />
        </div>
    </div>
</div>

<script>
    import { toPng } from "html-to-image";

    function initDownloadButtons() {
        const wrappers = document.querySelectorAll(".concept-map-wrapper");

        wrappers.forEach((wrapper) => {
            const btn = wrapper.querySelector(".download-map-btn");
            const container = wrapper.querySelector(".concept-map-container");
            const title =
                wrapper.getAttribute("data-title") || "mapa-conceptual";

            if (btn && container instanceof HTMLElement) {
                btn.addEventListener("click", async () => {
                    const span = btn.querySelector("span");
                    const originalText = span ? span.textContent : "Descargar";
                    if (span) span.textContent = "Generando...";
                    btn.classList.add("loading");

                    try {
                        await new Promise((r) => setTimeout(r, 100));

                        const dataUrl = await toPng(container, {
                            backgroundColor: "#ffffff",
                            pixelRatio: 2,
                            filter: (node: any) => {
                                return !node.classList?.contains(
                                    "download-map-btn",
                                );
                            },
                        });

                        const link = document.createElement("a");
                        link.download = `Ediprofe-${title.replace(/\s+/g, "-")}.png`;
                        link.href = dataUrl;
                        link.click();
                    } catch (err) {
                        console.error("Error al exportar imagen:", err);
                        alert(
                            "No se pudo generar la imagen. Intenta nuevamente.",
                        );
                    } finally {
                        if (span) span.textContent = originalText;
                        btn.classList.remove("loading");
                    }
                });
            }
        });
    }

    // Ejecutar en carga inicial y transiciones de Astro
    initDownloadButtons();
    document.addEventListener("astro:page-load", initDownloadButtons);
</script>

<style>
    @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap");

    .concept-map-wrapper {
        position: relative;
        margin: 3rem 0;
    }

    .concept-map-container {
        background-color: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        padding: 1.5rem 2rem;
        font-family: "Space Grotesk", sans-serif;
        color: #334155;
        position: relative;
        overflow: hidden;
    }

    .concept-map-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: #2563eb;
    }

    /* Estilos Botón Descarga */
    .download-map-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        color: #64748b;
        font-family: inherit;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        z-index: 10;
    }

    .download-map-btn:hover {
        background: #f1f5f9;
        color: #2563eb;
        border-color: #cbd5e1;
        transform: translateY(-1px);
    }

    .download-map-btn.loading {
        opacity: 0.7;
        pointer-events: none;
    }

    .map-root {
        margin-bottom: 1rem;
    }

    .root-label {
        font-weight: 400;
        font-size: 1.3rem;
        color: #0f172a;
        letter-spacing: -0.02em;
    }

    .root-v-line {
        color: #cbd5e1;
        margin-left: 0.1rem;
        font-size: 0.9rem;
        margin-top: 0.2rem;
    }

    .map-branches {
        border-left: 1.5px solid #cbd5e1;
        margin-left: 0.5rem;
        padding-left: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
        padding-top: 0.5rem;
    }
</style>
