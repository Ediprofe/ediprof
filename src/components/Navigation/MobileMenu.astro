---
import { getCollection } from 'astro:content';
import { buildNavigationFromLessonsWithCollection, mergeNavigations } from '../../utils/navigation-generator.js';
import { allMeta } from '../../utils/load-meta';
import { getMateriaConfig } from '../../config/materias';
import { MATERIA_SLUGS } from '../../types/content';

interface Props {
  currentPath: string;
}

const { currentPath } = Astro.props;

// Obtener navegaci贸n de cada colecci贸n
let navigation: any = {};

try {
  const matematicas = await getCollection('matematicas');
  const navMat = buildNavigationFromLessonsWithCollection(matematicas, 'matematicas', allMeta);
  navigation = mergeNavigations(navigation, navMat);
} catch (e) {}

try {
  const fisica = await getCollection('fisica');
  const navFis = buildNavigationFromLessonsWithCollection(fisica, 'fisica', allMeta);
  navigation = mergeNavigations(navigation, navFis);
} catch (e) {}

try {
  const quimica = await getCollection('quimica');
  const navQui = buildNavigationFromLessonsWithCollection(quimica, 'quimica', allMeta);
  navigation = mergeNavigations(navigation, navQui);
} catch (e) {}

try {
  const ciencias = await getCollection('ciencias');
  const navCie = buildNavigationFromLessonsWithCollection(ciencias, 'ciencias', allMeta);
  navigation = mergeNavigations(navigation, navCie);
} catch (e) {}

// materiaConfig importado desde config/materias.ts

// Funci贸n para contar lecciones de una materia
const countLessons = (materia: any) => {
  return Object.values(materia.unidades).reduce((acc: number, unidad: any) => {
    return acc + Object.values(unidad.bloques).reduce((acc2: number, bloque: any) => acc2 + bloque.lecciones.length, 0);
  }, 0);
};

// Filtrar materias que tienen al menos 1 lecci贸n
const filteredNavigation = Object.fromEntries(
  Object.entries(navigation).filter(([_, materia]: [string, any]) => countLessons(materia) > 0)
);
---

<div class="mobile-menu-container">
  <!-- Bot贸n de men煤 premium -->
  <button class="mobile-menu-toggle" aria-label="Abrir men煤" id="mobile-menu-toggle">
    <span class="hamburger-icon">
      <span></span>
      <span></span>
      <span></span>
    </span>
  </button>
  
  <div class="mobile-menu-overlay" id="mobile-menu-overlay"></div>
  
  <!-- Men煤 m贸vil premium -->
  <nav class="mobile-menu" id="mobile-menu" aria-hidden="true">
    <div class="mobile-menu-header">
      <a href="/" class="logo">
        <div class="logo-icon-wrapper">
          <span class="logo-icon"></span>
        </div>
        <div class="logo-text-wrapper">
          <span class="logo-text">Ediprofe</span>
          <span class="logo-tagline">Tu gu铆a educativa</span>
        </div>
      </a>
      <button class="mobile-menu-close" aria-label="Cerrar men煤" id="mobile-menu-close">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    
    <div class="mobile-menu-content">
      <div class="nav-label">Materias</div>
      
      {Object.entries(filteredNavigation).map(([materiaKey, materia]: [string, any]) => {
        const config = getMateriaConfig(materiaKey);
        const isMateriaActive = currentPath.startsWith(`/${materiaKey}`);
        const lessonCount = Object.values(materia.unidades).reduce((acc: number, unidad: any) => {
          return acc + Object.values(unidad.bloques).reduce((acc2: number, bloque: any) => acc2 + bloque.lecciones.length, 0);
        }, 0);
        
        return (
          <details class={`nav-details materia-details materia-${materiaKey}`} open={isMateriaActive}>
            <summary class={`nav-materia-summary ${isMateriaActive ? 'active' : ''}`}>
              <div class="materia-icon" style={`background: ${config.gradient}`}>{config.icon}</div>
              <div class="materia-info">
                <span class="materia-name">{materia.name}</span>
                <span class="materia-count">{lessonCount} lecciones</span>
              </div>
              <span class="nav-chevron">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="9 18 15 12 9 6"/>
                </svg>
              </span>
            </summary>
            
            <div class="nav-children">
              {Object.entries(materia.unidades).map(([unidadKey, unidad]: [string, any], unidadIndex: number) => {
                const isUnidadActive = currentPath.includes(`/${unidadKey}`);
                
                return (
                  <details class="nav-details unidad-details" open={isUnidadActive}>
                    <summary class={`nav-unidad-summary ${isUnidadActive ? 'active' : ''}`}>
                      <span class="unidad-number" style={`background: ${config.gradient}`}>{unidadIndex + 1}</span>
                      <span class="unidad-name">{unidad.name}</span>
                      <span class="nav-chevron-small">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="9 18 15 12 9 6"/>
                        </svg>
                      </span>
                    </summary>
                    
                    <div class="nav-children-inner">
                      {Object.entries(unidad.bloques).map(([bloqueKey, bloque]: [string, any]) => {
                        const isBloqueActive = currentPath.includes(`/${bloqueKey}`);
                        
                        return (
                          <details class="nav-details bloque-details">
                            <summary class={`nav-bloque-summary ${isBloqueActive ? 'active' : ''}`}>
                              <span class="bloque-indicator" style={`background: ${config.color}`}></span>
                              <span class="bloque-name">{bloque.name}</span>
                              <span class="bloque-count">{bloque.lecciones.length}</span>
                            </summary>
                            
                            <ul class="nav-lessons">
                              {bloque.lecciones.map((leccion: any, leccionIndex: number) => {
                                const isActive = currentPath === `/${leccion.slug}` || currentPath.endsWith(leccion.slug);
                                return (
                                  <li>
                                    <a 
                                      href={`/${leccion.slug}`}
                                      class:list={['nav-lesson', { active: isActive }]}
                                      style={isActive ? `--accent-color: ${config.color}` : ''}
                                    >
                                      <span class="lesson-number">{leccionIndex + 1}</span>
                                      <span class="lesson-title">{leccion.title}</span>
                                      {isActive && <span class="lesson-active-dot" style={`background: ${config.color}`}></span>}
                                    </a>
                                  </li>
                                );
                              })}
                            </ul>
                          </details>
                        );
                      })}
                    </div>
                  </details>
                );
              })}
            </div>
          </details>
        );
      })}
      
      {Object.keys(filteredNavigation).length === 0 && (
        <div class="mobile-nav-empty">
          <div class="empty-icon"></div>
          <p>No hay contenido disponible</p>
        </div>
      )}
    </div>
    
    </nav>
</div>

<script>
  const toggle = document.getElementById('mobile-menu-toggle');
  const menu = document.getElementById('mobile-menu');
  const overlay = document.getElementById('mobile-menu-overlay');
  const close = document.getElementById('mobile-menu-close');
  
  function openMenu() {
    menu?.classList.add('open');
    overlay?.classList.add('open');
    menu?.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
  }
  
  function closeMenu() {
    menu?.classList.remove('open');
    overlay?.classList.remove('open');
    menu?.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }
  
  toggle?.addEventListener('click', openMenu);
  close?.addEventListener('click', closeMenu);
  overlay?.addEventListener('click', closeMenu);
  
  // Cerrar con Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeMenu();
  });
</script>

<style>
  @import '../../styles/components/mobile-menu.css';
</style>

