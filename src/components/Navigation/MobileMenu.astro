---
import { getMateriaConfig } from '../../config/materias';
import { loadContextualNavigation, MATERIAS_LIST } from '../../utils/navigation-loader';

interface Props {
  currentPath: string;
}

const { currentPath } = Astro.props;

// Cargar navegaci贸n contextual (l贸gica centralizada en navigation-loader.ts)
const {
  navigation,
  materiaStats,
  isMateriaActive,
  isUnidadActive,
  isBloqueActive,
} = await loadContextualNavigation(currentPath);
---

<div class="mobile-menu-container">
  <!-- Bot贸n de men煤 premium -->
  <button class="mobile-menu-toggle" aria-label="Abrir men煤" id="mobile-menu-toggle">
    <span class="hamburger-icon">
      <span></span>
      <span></span>
      <span></span>
    </span>
  </button>
  
  <div class="mobile-menu-overlay" id="mobile-menu-overlay"></div>
  
  <!-- Men煤 m贸vil premium -->
  <nav class="mobile-menu" id="mobile-menu" aria-hidden="true">
    <div class="mobile-menu-header">
      <a href="/" class="logo">
        <div class="logo-icon-wrapper">
          <span class="logo-icon"></span>
        </div>
        <div class="logo-text-wrapper">
          <span class="logo-text">Ediprofe</span>
          <span class="logo-tagline">Tu gu铆a educativa</span>
        </div>
      </a>
      <button class="mobile-menu-close" aria-label="Cerrar men煤" id="mobile-menu-close">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    
    <div class="mobile-menu-content">
      <div class="nav-label">Materias</div>
      
      {/* Navegaci贸n Colapsada */}
      {MATERIAS_LIST.map((materiaKey) => {
        const stats = materiaStats[materiaKey];
        if (!stats) return null;
        
        const config = getMateriaConfig(materiaKey);
        const isActive = isMateriaActive(materiaKey);
        const materia = navigation[materiaKey];
        
        return (
          <div class={`nav-section nav-section-${materiaKey}`}>
            {/* Materia NO activa: enlace compacto */}
            {!isActive ? (
              <a href={`/${materiaKey}`} class="nav-materia-link">
                <div class="materia-icon" style={`background: ${config.gradient}`}>{config.icon}</div>
                <div class="materia-info">
                  <span class="materia-name">{stats.name}</span>
                  <span class="materia-count">{stats.count} lecciones</span>
                </div>
                <span class="nav-chevron">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"/>
                  </svg>
                </span>
              </a>
            ) : (
              /* Materia ACTIVA: estructura colapsada */
              <details open class="nav-details materia-details">
                <summary class="nav-materia-summary active">
                  <div class="materia-icon" style={`background: ${config.gradient}`}>{config.icon}</div>
                  <div class="materia-info">
                    <span class="materia-name">{materia?.name || stats.name}</span>
                    <span class="materia-count">{stats.count} lecciones</span>
                  </div>
                  <span class="nav-chevron">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="9 18 15 12 9 6"/>
                    </svg>
                  </span>
                </summary>
                
                <div class="nav-children">
                  {materia && Object.entries(materia.unidades).map(([unidadKey, unidad]: [string, any], unidadIndex: number) => {
                    const unidadActive = isUnidadActive(unidadKey);
                    
                    return (
                      <details open={unidadActive} class="nav-details unidad-details">
                        <summary class={`nav-unidad-summary ${unidadActive ? 'active' : ''}`}>
                          <span class="unidad-number" style={`background: ${config.gradient}`}>{unidadIndex + 1}</span>
                          <span class="unidad-name">{unidad.name}</span>
                          <span class="nav-chevron-small">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <polyline points="9 18 15 12 9 6"/>
                            </svg>
                          </span>
                        </summary>
                        
                        <div class="nav-children-inner">
                          {Object.entries(unidad.bloques).map(([bloqueKey, bloque]: [string, any]) => {
                            const bloqueActive = isBloqueActive(bloqueKey);
                            
                            return (
                              <details open={bloqueActive} class="nav-details bloque-details">
                                <summary class={`nav-bloque-summary ${bloqueActive ? 'active' : ''}`}>
                                  <span class="bloque-indicator" style={`background: ${config.color}`}></span>
                                  <span class="bloque-name">{bloque.name}</span>
                                  <span class="bloque-count">{bloque.lecciones.length}</span>
                                </summary>
                                
                                <ul class="nav-lessons">
                                  {bloque.lecciones.map((leccion: any, leccionIndex: number) => {
                                    const isLessonActive = currentPath === `/${leccion.slug}` || currentPath.endsWith(leccion.slug);
                                    return (
                                      <li>
                                        <a 
                                          href={`/${leccion.slug}`}
                                          class:list={['nav-lesson', { active: isLessonActive }]}
                                          style={isLessonActive ? `--accent-color: ${config.color}` : ''}
                                        >
                                          <span class="lesson-number">{leccionIndex + 1}</span>
                                          <span class="lesson-title">{leccion.title}</span>
                                          {isLessonActive && <span class="lesson-active-dot" style={`background: ${config.color}`}></span>}
                                        </a>
                                      </li>
                                    );
                                  })}
                                </ul>
                              </details>
                            );
                          })}
                        </div>
                      </details>
                    );
                  })}
                </div>
              </details>
            )}
          </div>
        );
      })}
      
      {Object.keys(materiaStats).length === 0 && (
        <div class="mobile-nav-empty">
          <div class="empty-icon"></div>
          <p>No hay contenido disponible</p>
        </div>
      )}
    </div>
    
    </nav>
</div>

<script>
  const toggle = document.getElementById('mobile-menu-toggle');
  const menu = document.getElementById('mobile-menu');
  const overlay = document.getElementById('mobile-menu-overlay');
  const close = document.getElementById('mobile-menu-close');
  
  function openMenu() {
    menu?.classList.add('open');
    overlay?.classList.add('open');
    menu?.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
  }
  
  function closeMenu() {
    menu?.classList.remove('open');
    overlay?.classList.remove('open');
    menu?.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }
  
  toggle?.addEventListener('click', openMenu);
  close?.addEventListener('click', closeMenu);
  overlay?.addEventListener('click', closeMenu);
  
  // Cerrar con Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeMenu();
  });
</script>

<style>
  @import '../../styles/components/mobile-menu.css';
</style>

