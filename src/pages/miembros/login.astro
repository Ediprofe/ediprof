---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Layout/Header.astro';
import Footer from '../../components/Layout/Footer.astro';
import SectionHeader from '../../components/UI/SectionHeader.astro';
import '../../styles/members.css';
---

<BaseLayout title="Miembros | Iniciar sesión" showTopBar={false}>
  <div class="members-hub">
    <Header />

    <main class="members-container">
      <SectionHeader
        badge="Miembros"
        title="Zona de Estudiantes"
        description="Inicia sesión para entrar a los talleres tipo Saber con retroalimentación inmediata."
      />

      <section class="members-card">
        <form id="login-form" class="members-form">
          <label class="members-label" for="api-base">API Base URL</label>
          <input id="api-base" class="members-input" type="url" required />

          <label class="members-label" for="email">Correo</label>
          <input id="email" class="members-input" type="email" required />

          <label class="members-label" for="password">Contraseña</label>
          <input id="password" class="members-input" type="password" required />

          <div class="members-actions">
            <button class="members-button" type="submit">Iniciar sesión</button>
            <a class="members-button secondary" href="/miembros/registro">Crear cuenta</a>
          </div>
        </form>
        <div id="feedback"></div>
      </section>
    </main>

    <Footer />
  </div>
</BaseLayout>

<script>
  import { apiLogin, getApiBase, saveSession, setApiBase } from '../../scripts/members/client';

  const form = document.getElementById('login-form');
  const feedback = document.getElementById('feedback');
  const apiBaseInput = document.getElementById('api-base');

  apiBaseInput.value = getApiBase();

  form?.addEventListener('submit', async (event) => {
    event.preventDefault();
    feedback.innerHTML = '';

    const email = /** @type {HTMLInputElement} */ (document.getElementById('email')).value;
    const password = /** @type {HTMLInputElement} */ (document.getElementById('password')).value;
    const apiBase = apiBaseInput.value;

    try {
      setApiBase(apiBase);
      const response = await apiLogin({
        email,
        password,
        device_name: 'web-miembros',
      });

      if (!response.data?.token || !response.data?.user) {
        throw new Error('No se recibió token de sesión.');
      }

      saveSession(response.data.token, response.data.user);
      window.location.href = '/miembros';
    } catch (error) {
      const message = error instanceof Error ? error.message : 'No fue posible iniciar sesión.';
      feedback.innerHTML = `<div class="members-alert error">${message}</div>`;
    }
  });
</script>
