---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Layout/Header.astro';
import Footer from '../../components/Layout/Footer.astro';
import SectionHeader from '../../components/UI/SectionHeader.astro';
import '../../styles/members.css';
---

<BaseLayout title="Miembros | Registro" showTopBar={false}>
  <div class="members-hub">
    <Header />

    <main class="members-container">
      <SectionHeader
        badge="Miembros"
        title="Crear Cuenta de Estudiante"
        description="Tu cuenta quedará pendiente y el administrador del colegio la aprobará manualmente."
      />

      <section class="members-card">
        <form id="register-form" class="members-form">
          <label class="members-label" for="api-base">API Base URL</label>
          <input id="api-base" class="members-input" type="url" required />

          <label class="members-label" for="name">Nombre</label>
          <input id="name" class="members-input" type="text" required />

          <label class="members-label" for="email">Correo</label>
          <input id="email" class="members-input" type="email" required />

          <label class="members-label" for="password">Contraseña</label>
          <input id="password" class="members-input" type="password" minlength="8" required />

          <label class="members-label" for="password-confirm">Confirmar contraseña</label>
          <input id="password-confirm" class="members-input" type="password" minlength="8" required />

          <div class="members-actions">
            <button class="members-button" type="submit">Registrarme</button>
            <a class="members-button secondary" href="/miembros/login">Ya tengo cuenta</a>
          </div>
        </form>
        <div id="feedback"></div>
      </section>
    </main>

    <Footer />
  </div>
</BaseLayout>

<script>
  import { apiRegister, getApiBase, setApiBase } from '../../scripts/members/client';

  const form = document.getElementById('register-form');
  const feedback = document.getElementById('feedback');
  const apiBaseInput = document.getElementById('api-base');

  apiBaseInput.value = getApiBase();

  form?.addEventListener('submit', async (event) => {
    event.preventDefault();
    feedback.innerHTML = '';

    const name = /** @type {HTMLInputElement} */ (document.getElementById('name')).value;
    const email = /** @type {HTMLInputElement} */ (document.getElementById('email')).value;
    const password = /** @type {HTMLInputElement} */ (document.getElementById('password')).value;
    const passwordConfirmation = /** @type {HTMLInputElement} */ (
      document.getElementById('password-confirm')
    ).value;
    const apiBase = apiBaseInput.value;

    try {
      setApiBase(apiBase);
      await apiRegister({
        name,
        email,
        password,
        password_confirmation: passwordConfirmation,
      });

      feedback.innerHTML = `
        <div class="members-alert ok">
          Registro exitoso. Tu cuenta quedó pendiente de aprobación.  
          <a class="members-link" href="/miembros/login">Inicia sesión aquí</a>.
        </div>
      `;
      form.reset();
      apiBaseInput.value = getApiBase();
    } catch (error) {
      const message = error instanceof Error ? error.message : 'No fue posible registrar la cuenta.';
      feedback.innerHTML = `<div class="members-alert error">${message}</div>`;
    }
  });
</script>
