---
/**
 * /print-saber/[...slug].astro
 *
 * Vista de impresión nativa para Talleres Saber.
 * Soporta 3 modos vía query param ?mode=
 * - default: 1 columna, limpio (PDF Normal)
 * - imprimible: 2 columnas, compacto (PDF Imprimible)
 * - feedback: 1 columna, respuestas visibles (PDF Retroalimentación)
 */
import { getCollection } from "astro:content";
import { cleanSlug, formatName } from "../../utils/navigation-generator.js";

export async function getStaticPaths() {
    const talleres = await getCollection("saber");

    return talleres.map((taller) => {
        // slug ejemplo: quimica/01-la-materia/taller
        return {
            params: { slug: cleanSlug(taller.slug) },
            props: { taller },
        };
    });
}

const { taller } = Astro.props;
const { Content, headings } = await taller.render();

// Título y metadatos
const firstH1 = headings.find((h: any) => h.depth === 1);
const title =
    taller.data.title ||
    firstH1?.text?.replace(/\*\*/g, "").trim() ||
    "Taller Saber 11";

// Formatear unidad y materia desde el slug
const parts = taller.slug.split("/"); // [materia, unidad, archivo]
const materia = parts[0]
    ? parts[0].charAt(0).toUpperCase() + parts[0].slice(1)
    : "Saber 11";
const unidad = parts[1] ? formatName(parts[1]) : "";
---

<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{title} - Ediprofe</title>

        <!-- Estilos base iguales a la web para consistencia -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        />

        <style is:global>
            /* ═══════════════════════════════════════════════════════════════
               VARIABLES & TIPOGRAFÍA (Editorial Standard)
               ═══════════════════════════════════════════════════════════════ */
            @import url("https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Inter:wght@400;600;700;800&display=swap");

            :root {
                --c-primary: #2563eb;
                --c-primary-light: #eff6ff;
                --c-text: #1e293b;
                --c-text-light: #64748b;
                --c-border: #e2e8f0;
                --f-body: "Merriweather", serif;
                --f-ui: "Inter", sans-serif;
            }

            body {
                font-family: var(--f-body);
                font-size: 11pt;
                line-height: 1.6;
                color: var(--c-text);
                margin: 0;
                padding: 0.5in;
                background: white;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .doc-header {
                display: flex;
                flex-direction: column;
                align-items: center;
                border-bottom: 3px solid var(--c-primary);
                padding-bottom: 20px;
                margin-bottom: 30px;
                text-align: center;
            }

            .doc-brand {
                font-family: var(--f-ui);
                font-weight: 800;
                font-size: 14pt;
                color: var(--c-primary);
                text-transform: uppercase;
                letter-spacing: 2px;
                margin-bottom: 8px;
            }

            .doc-title {
                font-family: var(--f-ui);
                font-size: 20pt;
                font-weight: 800;
                line-height: 1.2;
                color: #0f172a;
            }

            .doc-meta {
                font-family: var(--f-ui);
                font-size: 10pt;
                color: var(--c-text-light);
                margin-top: 8px;
                font-weight: 500;
                background: var(--c-primary-light);
                padding: 4px 12px;
                border-radius: 99px;
            }

            .content-wrapper {
                max-width: 800px;
                margin: 0 auto;
            }

            h2 {
                font-family: var(--f-ui);
                font-size: 13pt;
                font-weight: 700;
                color: var(--c-primary);
                margin-top: 30px;
                margin-bottom: 12px;
                border-left: 4px solid var(--c-primary);
                padding-left: 10px;
                break-after: avoid;
                break-inside: avoid;
            }

            p {
                margin-bottom: 12px;
                text-align: justify;
            }

            blockquote,
            .contexto {
                background: #f8fafc;
                border-left: 3px solid #64748b;
                padding: 15px 20px;
                margin: 20px 0;
                font-size: 10.5pt;
                font-style: italic;
                color: #334155;
                border-radius: 0 8px 8px 0;
                break-inside: avoid;
            }

            img {
                max-width: 100%;
                height: auto;
                margin: 15px auto;
                display: block;
                border-radius: 8px;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                border: 1px solid var(--c-border);
                max-height: 350px;
                object-fit: contain;
                break-inside: avoid;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin: 15px 0;
                font-family: var(--f-ui);
                font-size: 9pt;
            }
            th,
            td {
                border: 1px solid var(--c-border);
                padding: 8px 12px;
                text-align: left;
            }
            th {
                background: #f1f5f9;
                color: #334155;
                font-weight: 700;
                text-align: center;
            }

            .saber-opciones {
                list-style: none;
                padding: 0;
                margin: 15px 0 25px 0;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .opcion-item {
                display: flex;
                align-items: flex-start;
                gap: 15px;
                padding: 12px 16px;
                background: white;
                border: 1px solid var(--c-border);
                border-radius: 12px;
                break-inside: avoid;
            }

            .opcion-item::before {
                content: var(--custom-letter, counter(saber-opt, upper-alpha));
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: 32px;
                height: 32px;
                background: linear-gradient(135deg, #3b82f6, #2563eb);
                color: white;
                font-family: var(--f-ui);
                font-weight: 700;
                font-size: 11pt;
                border-radius: 8px;
                flex-shrink: 0;
                margin-top: 2px;
            }

            li.opcion-item {
                background: white !important;
                border: 1px solid var(--c-border) !important;
                padding: 12px 16px !important;
            }

            /* ═══════════════════════════════════════════════════════════════
               MODO IMPRIMIBLE (TINTA ECONÓMICA & ESPACIO ULTRA OPTIMIZADO)
               ═══════════════════════════════════════════════════════════════ */
            body.mode-imprimible {
                padding: 0 !important;
                font-size: 8.5pt !important;
                line-height: 1.15 !important; /* Interlineado ULTRA-REDUCIDO */
            }

            body.mode-imprimible .content-wrapper {
                max-width: none;
                column-count: 2;
                column-gap: 0.6cm;
                column-rule: 0.5px solid #ccc;
            }

            body.mode-imprimible .doc-header {
                margin-bottom: 4px;
                padding-bottom: 2px;
                column-span: all;
                border-bottom: 1px solid #000;
            }
            body.mode-imprimible .doc-title {
                font-size: 10pt;
                text-align: left;
            }
            body.mode-imprimible .doc-brand,
            body.mode-imprimible .doc-meta {
                display: none !important;
            }

            /* Preguntas */
            body.mode-imprimible .pregunta-header .meta-tags,
            body.mode-imprimible .meta-tags,
            body.mode-imprimible .tag,
            body.mode-imprimible .hash {
                display: none !important;
            }

            body.mode-imprimible .pregunta-header {
                display: inline;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
                float: left;
            }

            body.mode-imprimible .numero-pregunta {
                display: inline-block;
                font-size: 9pt !important;
                font-weight: 800;
                color: #000 !important;
                margin-right: 3px !important;
                line-height: 1.15;
            }

            body.mode-imprimible .numero-pregunta::after {
                content: ".";
            }

            body.mode-imprimible .saber-pregunta {
                margin-bottom: 12px !important; /* Más espacio entre preguntas para separar visualmente */
                break-inside: auto !important;
                display: flow-root;
            }

            body.mode-imprimible .pregunta-contenido {
                display: inline;
            }

            body.mode-imprimible h2:not(.numero-pregunta) {
                float: left;
                margin: 0 4px 0 0;
                font-size: 9pt;
                color: black;
            }

            /* TABLES */
            body.mode-imprimible table {
                font-size: 7.5pt;
                width: 100%;
                table-layout: auto !important;
                border-collapse: collapse;
                margin: 1.5px 0;
                break-inside: avoid;
                display: table;
            }
            body.mode-imprimible th,
            body.mode-imprimible td {
                padding: 1px 2px;
                border: 0.5px solid #000;
            }

            /* ═══════════════════════════════════════════════════════════════
               OPCIONES ULTRA COMPACTAS (LISTADO PEQUEÑO)
               ═══════════════════════════════════════════════════════════════ */
            body.mode-imprimible .saber-opciones {
                margin: 2px 0 4px 0 !important;
                display: block;
                clear: both;
                padding: 0 !important;
                list-style: none !important;
            }

            body.mode-imprimible .opcion-item,
            body.mode-imprimible li.opcion-item {
                border: none !important;
                background: transparent !important;
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important; /* Quitar márgenes/interlineado extra entre opciones */
                gap: 5px;
                font-size: 8pt !important;
                align-items: flex-start;
                break-inside: avoid;
                border-radius: 0 !important;
            }

            /* Badge convertido en simple texto con punto (Ej: A.) */
            body.mode-imprimible .opcion-item::before,
            body.mode-imprimible li.opcion-item::before {
                content: var(--custom-letter, counter(saber-opt, upper-alpha))
                    ".";
                background: none !important;
                border: none !important;
                color: #000 !important;
                box-shadow: none !important;
                min-width: 1.1em !important;
                width: auto !important;
                height: auto !important;
                font-size: 8pt !important;
                font-weight: 900;
                margin-top: 0 !important;
                display: inline-block !important;
                text-align: left !important;
                padding: 0 !important;
            }

            body.mode-imprimible .opcion-item p {
                margin: 0 !important;
                padding: 0 !important;
                line-height: 1.15 !important;
                text-align: left;
                display: inline;
            }

            /* Contexto super compacto */
            body.mode-imprimible blockquote,
            body.mode-imprimible .contexto {
                padding: 1px 4px;
                margin: 2px 0;
                background: transparent;
                border-left: 1.5px solid #ccc;
                font-size: 8pt;
                color: #333;
                clear: both;
                display: block;
            }

            /* Imágenes compactas pero legibles */
            body.mode-imprimible img {
                margin: 4px auto !important;
                max-width: 100% !important;
                height: auto !important;
                max-height: 220px !important; /* Límite más generoso para no perder detalle */
                display: block !important;
                border: 0.5px solid #000;
                clear: both;
            }

            body.mode-imprimible .meta-pregunta,
            body.mode-imprimible span[data-competencia],
            body.mode-imprimible span[data-componente] {
                display: none !important;
            }

            /* ═══════════════════════════════════════════════════════════════
               UTILIDADES DE DISEÑO (FULL-WIDTH)
               ═══════════════════════════════════════════════════════════════ */
            .span-all {
                column-span: all;
                width: 100%;
                margin: 10px 0;
                clear: both;
            }

            body.mode-imprimible .span-all img {
                max-height: 500px !important; /* Expansión casi total para gráficas complejas */
                width: auto !important;
                max-width: 98% !important;
            }

            body.mode-imprimible .span-all blockquote,
            body.mode-imprimible .span-all .contexto {
                font-size: 9pt; /* Un poco más grande para lecturas expandidas */
                border-left: 3px solid #ccc;
            }

            /* ═══════════════════════════════════════════════════════════════
               MODO FEEDBACK (RESPUESTAS)
               ═══════════════════════════════════════════════════════════════ */
            details {
                display: none;
            }

            body.mode-feedback details {
                display: block;
                margin-top: 10px;
                padding: 10px;
                background: #f0fdf4;
                border: 1px solid #bbf7d0;
                border-radius: 6px;
                page-break-inside: avoid;
            }

            body.mode-feedback summary {
                font-family: var(--f-ui);
                font-weight: 700;
                color: #166534;
                margin-bottom: 5px;
                list-style: none;
                display: flex;
                align-items: center;
                gap: 5px;
            }

            body.mode-feedback summary::before {
                content: "✅";
            }

            body.mode-feedback .opcion-item[data-is-correct="true"] {
                border-color: #22c55e !important;
                background-color: #f0fdf4 !important;
            }

            body.mode-feedback .opcion-item[data-is-correct="true"]::before {
                background: linear-gradient(
                    135deg,
                    #22c55e,
                    #16a34a
                ) !important;
            }
        </style>

        <script>
            const params = new URLSearchParams(window.location.search);
            const mode = params.get("mode");
            if (mode) {
                document.body.classList.add(`mode-${mode}`);
                if (mode === "feedback") {
                    document
                        .querySelectorAll("details")
                        .forEach((d) => d.setAttribute("open", "true"));
                }
            }
        </script>
    </head>
    <body>
        <header class="doc-header">
            <div class="doc-brand">Ediprofe</div>
            <div class="doc-title">{title}</div>
            <div class="doc-meta">{materia} • {unidad}</div>
        </header>

        <main class="content-wrapper">
            <Content />
        </main>
    </body>
</html>
