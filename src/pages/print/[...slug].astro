---
/**
 * /print/[...slug].astro
 * 
 * P√°gina de impresi√≥n para generar PDFs profesionales.
 * - Colores por materia
 * - Encabezado en TODAS las p√°ginas (running header)
 * - Primera p√°gina con presentaci√≥n especial
 * - T√≠tulo como hiperv√≠nculo a la web
 * 
 * USO:
 *   /print/fisica/introduccion-a-la-fisica/introduccion/la-fisica-y-sus-ramas
 */
import { getCollection } from 'astro:content';
import { cleanSlug, formatName } from '../../utils/navigation-generator.js';

// =========================================
// COLORES POR MATERIA (Fuente √∫nica de verdad)
// =========================================
const MATERIA_COLORS: Record<string, { primary: string; accent: string; light: string }> = {
  fisica: { primary: '#2563eb', accent: '#3b82f6', light: '#dbeafe' },       // Azul
  matematicas: { primary: '#dc2626', accent: '#ef4444', light: '#fee2e2' },  // Rojo
  quimica: { primary: '#ea580c', accent: '#f97316', light: '#ffedd5' },      // Naranja
  ciencias: { primary: '#16a34a', accent: '#22c55e', light: '#dcfce7' }      // Verde
};

// Nombres de materias con tildes
const MATERIA_NAMES: Record<string, string> = {
  matematicas: 'Matem√°ticas',
  fisica: 'F√≠sica',
  quimica: 'Qu√≠mica',
  ciencias: 'Ciencias'
};

export async function getStaticPaths() {
  const allLessons: Array<{ lesson: any; materia: string; cleanFullSlug: string }> = [];
  
  const addLessons = (lessons: any[], materiaName: string) => {
    lessons.forEach(lesson => {
      const cleanFullSlug = `${materiaName}/${cleanSlug(lesson.slug)}`;
      allLessons.push({ lesson, materia: materiaName, cleanFullSlug });
    });
  };
  
  try { addLessons(await getCollection('matematicas'), 'matematicas'); } catch (e) {}
  try { addLessons(await getCollection('fisica'), 'fisica'); } catch (e) {}
  try { addLessons(await getCollection('quimica'), 'quimica'); } catch (e) {}
  try { addLessons(await getCollection('ciencias'), 'ciencias'); } catch (e) {}
  
  return allLessons.map(item => ({
    params: { slug: item.cleanFullSlug },
    props: { lesson: item.lesson, materia: item.materia }
  }));
}

interface Props {
  lesson: any;
  materia: string;
}

const { lesson, materia } = Astro.props;
const { Content, headings } = await lesson.render();

// Colores de la materia
const colors = MATERIA_COLORS[materia] || MATERIA_COLORS.fisica;

// Extraer t√≠tulo de la lecci√≥n
const firstH1 = headings.find((h: any) => h.depth === 1);
const title = lesson.data?.title || firstH1?.text?.replace(/\*\*/g, '').trim() || 'Lecci√≥n';

// Extraer informaci√≥n del slug
const slugParts = lesson.slug.split('/');
let unidadName = '';
let temaName = '';

if (slugParts.length >= 1) {
  unidadName = formatName(slugParts[0]);
}

if (slugParts.length >= 2) {
  temaName = formatName(slugParts[1]);
}

// Nombre de materia con tilde
const materiaName = MATERIA_NAMES[materia] || materia.charAt(0).toUpperCase() + materia.slice(1);

// URL de la lecci√≥n en la web (usando cleanSlug)
const lessonUrl = `https://ediprofe.com/${materia}/${cleanSlug(lesson.slug)}`;
---

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{title} - {materiaName} - Ediprofe</title>
  
  <!-- KaTeX para matem√°ticas -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
    onload="renderMathInElement(document.body, {
      delimiters: [
        {left: '$$', right: '$$', display: true},
        {left: '$', right: '$', display: false}
      ]
    });"></script>
  
  <style define:vars={{ primaryColor: colors.primary, accentColor: colors.accent, lightColor: colors.light }}>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    /* ========================================
       CONFIGURACI√ìN DE P√ÅGINA Y ENCABEZADOS
       ======================================== */
    @page {
      size: letter;
      margin: 0.75in 0.6in 0.6in 0.6in;
      
      /* Encabezado repetido en todas las p√°ginas */
      @top-center {
        content: element(running-header);
      }
    }
    
    /* Primera p√°gina: margen superior m√°s grande para la presentaci√≥n */
    @page :first {
      margin-top: 0.4in;
      @top-center {
        content: none;
      }
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 11pt;
      line-height: 1.6;
      color: #1e293b;
      background: white;
      padding: 0;
    }
    
    /* ========================================
       RUNNING HEADER (encabezado en todas las p√°ginas)
       ======================================== */
    .running-header {
      position: running(running-header);
      font-size: 9pt;
      color: #64748b;
      padding: 8px 0;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }
    
    .running-header-left {
      font-weight: 600;
      color: var(--primaryColor);
    }
    
    .running-header-right {
      font-size: 8pt;
    }
    
    /* ========================================
       PRIMERA P√ÅGINA - PRESENTACI√ìN ESPECIAL
       ======================================== */
    .cover-header {
      background: linear-gradient(135deg, var(--primaryColor) 0%, color-mix(in srgb, var(--primaryColor) 80%, black) 100%);
      color: white;
      padding: 18px 24px;
      border-radius: 12px;
      margin-bottom: 24px;
    }
    
    .cover-header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }
    
    .cover-materia {
      font-size: 20pt;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .cover-brand {
      font-size: 11pt;
      font-weight: 500;
      opacity: 0.9;
    }
    
    .cover-meta {
      display: flex;
      gap: 32px;
      font-size: 10pt;
      opacity: 0.95;
    }
    
    .cover-meta-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .cover-meta-label {
      font-weight: 600;
      opacity: 0.8;
    }
    
    /* ========================================
       T√çTULO DE LA LECCI√ìN (hiperv√≠nculo)
       ======================================== */
    .lesson-title-container {
      text-align: center;
      padding: 24px 0;
      margin-bottom: 20px;
      border-bottom: 3px solid var(--primaryColor);
    }
    
    .lesson-title-link {
      font-size: 24pt;
      font-weight: 700;
      color: var(--primaryColor);
      text-decoration: none;
      line-height: 1.3;
    }
    
    .lesson-title-link:hover {
      text-decoration: underline;
    }
    
    /* ========================================
       CONTENIDO PRINCIPAL
       ======================================== */
    .print-content {
      max-width: 100%;
    }
    
    /* Ocultar el H1 del contenido (ya lo mostramos arriba) */
    .print-content :global(h1:first-of-type) {
      display: none;
    }
    
    .print-content :global(h2) {
      font-size: 15pt;
      font-weight: 600;
      color: var(--primaryColor);
      margin-top: 22px;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 2px solid var(--accentColor);
    }
    
    .print-content :global(h3) {
      font-size: 12pt;
      font-weight: 600;
      color: #334155;
      margin-top: 14px;
      margin-bottom: 6px;
    }
    
    /* P√°rrafos */
    .print-content :global(p) {
      margin-bottom: 10px;
      text-align: justify;
    }
    
    /* Listas */
    .print-content :global(ul),
    .print-content :global(ol) {
      margin-left: 24px;
      margin-bottom: 10px;
    }
    
    .print-content :global(li) {
      margin-bottom: 4px;
    }
    
    /* Im√°genes */
    .print-content :global(img) {
      max-width: 100%;
      height: auto;
      margin: 14px auto;
      display: block;
      border-radius: 8px;
    }
    
    /* Tablas */
    .print-content :global(table) {
      width: 100%;
      border-collapse: collapse;
      margin: 14px 0;
      font-size: 10pt;
    }
    
    .print-content :global(th),
    .print-content :global(td) {
      border: 1px solid #cbd5e1;
      padding: 6px 10px;
      text-align: left;
    }
    
    .print-content :global(th) {
      background: var(--primaryColor);
      color: white;
      font-weight: 600;
    }
    
    /* Blockquotes */
    .print-content :global(blockquote) {
      background: var(--lightColor);
      border-left: 4px solid var(--primaryColor);
      padding: 10px 14px;
      margin: 14px 0;
      font-style: italic;
    }
    
    /* C√≥digo */
    .print-content :global(code) {
      background: #f1f5f9;
      padding: 2px 5px;
      border-radius: 4px;
      font-family: 'Fira Code', monospace;
      font-size: 9pt;
    }
    
    .print-content :global(pre) {
      background: #1e293b;
      color: #e2e8f0;
      padding: 10px 14px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 14px 0;
      font-size: 9pt;
    }
    
    .print-content :global(pre code) {
      background: none;
      padding: 0;
      color: inherit;
    }
    
    /* L√≠neas horizontales */
    .print-content :global(hr) {
      border: none;
      border-top: 1px solid #e2e8f0;
      margin: 20px 0;
    }
    
    /* ========================================
       FOOTER
       ======================================== */
    .print-footer {
      margin-top: 28px;
      padding-top: 10px;
      border-top: 2px solid var(--primaryColor);
      display: flex;
      justify-content: space-between;
      font-size: 9pt;
      color: #64748b;
    }
    
    .footer-brand {
      color: var(--primaryColor);
      font-weight: 600;
    }
    
    /* Ocultar elementos interactivos */
    .print-content :global(details),
    .print-content :global(.interactive),
    .print-content :global(button) {
      display: none !important;
    }
    
    /* Math blocks */
    .print-content :global(.katex-display) {
      margin: 14px 0;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <!-- Running Header (aparece en todas las p√°ginas excepto la primera) -->
  <div class="running-header">
    <span class="running-header-left">üìò {materiaName} | {unidadName} | {temaName}</span>
    <span class="running-header-right">{title} ‚Ä¢ ediprofe.com</span>
  </div>

  <!-- Primera p√°gina: Encabezado de presentaci√≥n -->
  <header class="cover-header">
    <div class="cover-header-top">
      <div class="cover-materia">üìò {materiaName}</div>
      <div class="cover-brand">ediprofe.com</div>
    </div>
    <div class="cover-meta">
      {unidadName && (
        <div class="cover-meta-item">
          <span class="cover-meta-label">Unidad:</span>
          <span>{unidadName}</span>
        </div>
      )}
      {temaName && (
        <div class="cover-meta-item">
          <span class="cover-meta-label">Tema:</span>
          <span>{temaName}</span>
        </div>
      )}
    </div>
  </header>
  
  <!-- T√≠tulo de la lecci√≥n como hiperv√≠nculo -->
  <div class="lesson-title-container">
    <a href={lessonUrl} class="lesson-title-link">{title}</a>
  </div>
  
  <!-- Contenido -->
  <main class="print-content">
    <Content />
  </main>
  
  <!-- Footer -->
  <footer class="print-footer">
    <span class="footer-brand">üìö Ediprofe.com</span>
    <span>Educaci√≥n de calidad para todos</span>
  </footer>
</body>
</html>
