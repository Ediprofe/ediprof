---
import BaseLayout from './BaseLayout.astro';
import Footer from '../components/Layout/Footer.astro';
import CollapsibleSidebar from '../components/Navigation/CollapsibleSidebar.astro';
import TableOfContents from '../components/Content/TableOfContents.astro';
import MobileMenu from '../components/Navigation/MobileMenu.astro';
import StickyHeader from '../components/Layout/StickyHeader.astro';
import { getMetaName } from '../utils/load-meta';
import { formatName, formatBlockName, cleanSegment } from '../utils/navigation-generator.js';
import { materiaConfig, getMateriaName } from '../config/materias';
import { isMateriaSlug } from '../types/content';
import { cleanLatex } from '../utils/clean-latex';

interface Props {
  frontmatter: {
    title?: string;
    description?: string;
  };
  headings: Array<{ depth: number; slug: string; text: string }>;
  url: string;
  prevLesson?: { slug: string; title: string } | null;
  nextLesson?: { slug: string; title: string } | null;
}

const { frontmatter, headings, url, prevLesson, nextLesson } = Astro.props;
const title = frontmatter.title || headings.find(h => h.depth === 1)?.text || 'Sin t√≠tulo';

// Extraer navegaci√≥n de la URL (decodificar para manejar caracteres especiales como tildes)
const pathParts = url.split('/').filter(Boolean).map(part => decodeURIComponent(part));
const materia = pathParts[0] || '';
const unidad = pathParts[1] || '';
const bloque = pathParts[2] || '';

// Configuraci√≥n de colores por materia (usar centralizada)
const config = isMateriaSlug(materia) 
  ? materiaConfig[materia] 
  : materiaConfig.fisica;

// Obtener nombres con tildes desde metadatos (usar claves en min√∫sculas)
const materiaName = isMateriaSlug(materia) ? getMateriaName(materia) : formatName(materia);
const unidadKey = `${materia}/${unidad.toLowerCase()}`;
const bloqueKey = `${materia}/${unidad.toLowerCase()}/${bloque.toLowerCase()}`;
const unidadName = getMetaName(unidadKey, formatName(unidad));
const bloqueName = getMetaName(bloqueKey, formatBlockName(bloque));

// URLs limpias para navegaci√≥n
const cleanUnidad = cleanSegment(unidad);
const cleanBloque = cleanSegment(bloque);
---

<BaseLayout title={title} description={frontmatter.description} showTopBar={false}>
  <StickyHeader 
    showBreadcrumb={true}
    breadcrumbItems={[
      { label: 'Inicio', href: '/', icon: 'üè†' },
      { label: materiaName, href: `/${materia}`, icon: config.icon },
      { label: unidadName, href: `/${materia}/${cleanUnidad}` },
      { label: bloqueName, href: `/${materia}/${cleanUnidad}/${cleanBloque}` },
      { label: title }
    ]}
  />
  <MobileMenu currentPath={url} />
  
  <div class="lesson-container">
    <CollapsibleSidebar currentPath={url} />
    
    <main class="lesson-content">
      <!-- Header Premium de Lecci√≥n (incluye breadcrumb) -->
      <header class={`lesson-header lesson-header-${materia}`}>
        <div class="header-bg">
          <div class="header-orb header-orb-1"></div>
          <div class="header-orb header-orb-2"></div>
          <div class="header-grid"></div>
        </div>
        
        <div class="header-content">
          <div class="header-main">
            <div class="header-icon-wrapper" style={`background: ${config.gradient}`}>
              <span class="header-icon">üìñ</span>
            </div>
            <div class="header-text">
              <span class="header-label">Lecci√≥n</span>
              <h1 class="header-title">{title}</h1>
              {frontmatter.description && (
                <p class="header-desc">{frontmatter.description}</p>
              )}
            </div>
          </div>
          
          <div class="header-breadcrumb">
            <a href={`/${materia}`} class="crumb-link">
              <span class="crumb-icon">{config.icon}</span>
              <span>{materiaName}</span>
            </a>
            <span class="crumb-sep">‚Ä∫</span>
            <a href={`/${materia}/${cleanUnidad}`} class="crumb-link">{unidadName}</a>
            <span class="crumb-sep">‚Ä∫</span>
            <a href={`/${materia}/${cleanUnidad}/${cleanBloque}`} class="crumb-link">{bloqueName}</a>
          </div>
        </div>
      </header>
      
      <article class={`content-article content-article-${materia}`}>
        {headings.length > 2 && (
          <TableOfContents headings={headings} />
        )}
        
        <div class="content-body">
          <slot />
        </div>
      </article>
      
      <!-- Navegaci√≥n Premium -->
      <nav class="lesson-navigation">
        {prevLesson ? (
          <a href={`/${prevLesson.slug}`} class="nav-card nav-prev">
            <div class="nav-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
            </div>
            <div class="nav-content">
              <span class="nav-label">Lecci√≥n anterior</span>
              <span class="nav-title">{cleanLatex(prevLesson.title)}</span>
            </div>
          </a>
        ) : (
          <span class="nav-placeholder"></span>
        )}
        
        {nextLesson ? (
          <a href={`/${nextLesson.slug}`} class="nav-card nav-next">
            <div class="nav-content">
              <span class="nav-label">Siguiente lecci√≥n</span>
              <span class="nav-title">{cleanLatex(nextLesson.title)}</span>
            </div>
            <div class="nav-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
            </div>
          </a>
        ) : (
          <span class="nav-placeholder"></span>
        )}
      </nav>
    </main>
  </div>
  
  <Footer variant="minimal" />
</BaseLayout>

<style>
  @import '../styles/layouts/lesson.css';
</style>
